<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlowGenixAI Chat Widget</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f0f4f8;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        border-radius: 16px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background: white;
        overflow: hidden;
        transition: height 0.3s ease;
      }

      .chat-container.minimized {
        height: 60px;
      }

      .chat-header {
        background: linear-gradient(135deg, #009ce3 0%, #0077b3 100%);
        color: white;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        flex-shrink: 0;
      }

      .chat-title {
        font-weight: 600;
        font-size: 16px;
      }

      .chat-status {
        font-size: 12px;
        opacity: 0.9;
      }

      .minimize-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s ease;
      }

      .minimize-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .chat-container.minimized .chat-content {
        display: none;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px 16px;
      }

      .message {
        margin-bottom: 12px;
        border-radius: 12px;
        max-width: 85%;
        word-break: break-word;
        position: relative;
      }

      .message.user {
        background: #009ce3;
        color: white;
        align-self: flex-end;
        padding: 12px 16px;
      }

      .message.bot {
        background: #e5e7eb;
        color: #111827;
        align-self: flex-start;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 85%;
        word-break: break-word;
        margin-top: 10px;
        line-height: 1.5;
        position: relative;
      }

      .message-timestamp {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .message.user .message-timestamp {
        text-align: right;
      }

      .message.bot .message-timestamp {
        text-align: left;
      }

      .message:hover .message-timestamp {
        opacity: 1;
      }

      /* Remove default margins from all elements inside bot messages */
      .message.bot * {
        margin: 0;
        padding: 0;
      }

      /* Add controlled spacing between elements */
      .message.bot > *:not(:first-child) {
        margin-top: 8px;
      }

      /* Ensure first element has no top margin */
      .message.bot > *:first-child {
        margin-top: 0;
      }

      .message.bot h4 {
        font-size: 16px;
        font-weight: bold;
        color: #374151;
        margin-bottom: 4px;
      }

      .message.bot p {
        line-height: 1.5;
        margin-bottom: 4px;
      }

      .message.bot p:last-child {
        margin-bottom: 0;
      }

      .message.bot ol,
      .message.bot ul {
        padding-left: 20px;
        margin: 4px 0;
      }

      .message.bot li {
        margin-bottom: 4px;
        line-height: 1.4;
      }

      .message.bot a {
        color: #009ce3;
        text-decoration: underline;
      }

      .message.bot a:hover {
        text-decoration: none;
      }

      .message.bot strong {
        font-weight: bold;
        color: #374151;
      }

      .chat-input-container {
        flex-shrink: 0;
        display: flex;
        align-items: flex-start;
        padding: 12px;
        border-top: 1px solid #ccc;
        position: relative;
        padding-bottom: 32px;
        background: white;
      }

      .input-container {
        position: relative;
        flex: 1;
        margin-right: 8px;
      }

      #chat-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
      }

      #chat-send {
        padding: 10px 16px;
        background: #009ce3;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        height: fit-content;
        align-self: flex-start;
      }

      .typing {
        font-style: italic;
        opacity: 0.7;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6b7280;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .suggested-questions {
        margin: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .suggested-question {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        padding: 10px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        color: #374151;
        text-align: center;
      }

      .suggested-question:hover {
        background: #e5e7eb;
        border-color: #009ce3;
        color: #009ce3;
      }

      .quick-replies {
        margin: 10px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
      }

      .quick-reply {
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 16px;
        padding: 6px 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        color: #475569;
        white-space: nowrap;
      }

      .quick-reply:hover {
        background: #e2e8f0;
        border-color: #009ce3;
        color: #009ce3;
      }

      .message-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
        display: flex;
        gap: 4px;
        z-index: 10;
      }

      .message.bot:hover .message-actions {
        opacity: 1;
      }

      .copy-btn {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 12px;
        color: #374151;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 500;
        min-width: 50px;
        text-align: center;
      }

      .copy-btn:hover {
        background: #f9fafb;
        border-color: #009ce3;
        color: #009ce3;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .copy-btn:active {
        transform: translateY(0);
      }

      .copy-btn.copied {
        background: #dcfce7;
        border-color: #16a34a;
        color: #16a34a;
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 10px;
        margin: 8px 0;
        font-size: 14px;
      }

      .retry-button {
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        margin-top: 6px;
      }

      .retry-button:hover {
        background: #b91c1c;
      }

      .input-validation {
        position: absolute;
        bottom: -20px;
        left: 0;
        font-size: 11px;
        color: #dc2626;
        display: none;
      }

      .input-counter {
        position: absolute;
        bottom: -20px;
        right: 0;
        font-size: 11px;
        color: #6b7280;
        display: block;
      }

      .input-counter.warning {
        color: #f59e0b;
      }

      .input-counter.error {
        color: #dc2626;
      }

      #chat-input.error {
        border-color: #dc2626;
        background-color: #fef2f2;
      }

      /* Mobile Optimization */
      @media (max-width: 768px) {
        .chat-container {
          height: 100vh;
          border-radius: 0;
        }

        .message {
          max-width: 90%;
        }

        .suggested-question {
          font-size: 13px;
          padding: 12px 16px;
        }

        .quick-reply {
          font-size: 11px;
          padding: 8px 12px;
        }

        #chat-input {
          font-size: 16px;
          padding: 12px;
        }

        #chat-send {
          padding: 12px 18px;
          min-width: 60px;
        }

        .chat-input-container {
          padding: 16px;
          padding-bottom: 36px;
        }

        .message.bot,
        .message.user {
          padding: 10px 14px;
        }
      }

      @media (max-width: 480px) {
        .quick-replies {
          flex-direction: column;
        }

        .quick-reply {
          text-align: center;
        }

        .suggested-questions {
          margin: 15px 0;
        }

        .chat-messages {
          padding: 15px 12px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container" id="chat-container">
      <div class="chat-header">
        <div>
          <div class="chat-title">FlowGenixAI Assistant</div>
          <div class="chat-status" id="chat-status">Online • Ready to help</div>
        </div>
      </div>
      <div class="chat-content">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-container">
          <div class="input-container">
            <input
              type="text"
              id="chat-input"
              placeholder="Ask me anything..."
              maxlength="1000"
            />
            <div class="input-validation" id="input-validation"></div>
            <div class="input-counter" id="input-counter">0/1000</div>
          </div>
          <button id="chat-send">Send</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      var messages = document.getElementById("chat-messages");
      var input = document.getElementById("chat-input");
      var inputCounter = document.getElementById("input-counter");
      var inputValidation = document.getElementById("input-validation");
      var chatStatus = document.getElementById("chat-status");
      var chatHistory = [];
      var lastUserMessage = "";
      var STORAGE_KEY = "flowgenix_chat_history";
      var MAX_INPUT_LENGTH = 1000;

      // Quick reply options that appear after bot responses
      var quickReplies = [
        "Tell me more about your AI services",
        "What's the cost for AI implementation?",
        "Can you give me a real AI automation example?",
        "What's the next step to get started with AI?",
        "How long does AI integration typically take?",
      ];

      // Suggested questions
      var suggestedQuestions = [
        "What AI services does FlowGenixAI offer?",
        "How can AI help automate my business workflows?",
        "What's the ROI of implementing AI automation?",
        "How do I get started with AI integration?",
      ];

      // Session persistence functions
      function loadChatHistory() {
        try {
          var history = sessionStorage.getItem(STORAGE_KEY);
          return history ? JSON.parse(history) : [];
        } catch (error) {
          console.warn("Could not load chat history:", error);
          return [];
        }
      }

      function saveChatHistory() {
        try {
          sessionStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
        } catch (error) {
          console.warn("Could not save chat history:", error);
        }
      }

      function formatTimestamp(timestamp) {
        var date = new Date(timestamp);
        var now = new Date();
        var diffMs = now - date;
        var diffMins = Math.floor(diffMs / 60000);
        var diffHours = Math.floor(diffMs / 3600000);
        var diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return diffMins + "m ago";
        if (diffHours < 24) return diffHours + "h ago";
        if (diffDays < 7) return diffDays + "d ago";

        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function updateChatStatus(status) {
        chatStatus.textContent = status;
      }

      function restoreChatHistory() {
        for (var i = 0; i < chatHistory.length; i++) {
          var entry = chatHistory[i];
          appendMessage(entry.text, entry.sender, false, true, entry.timestamp);
        }
      }

      function formatBotResponse(text) {
        console.log("Original text:", text);

        var formatted = text.trim();

        // Auto-link URLs
        formatted = formatted.replace(
          /(https?:\/\/[^\s]+)/g,
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>',
        );

        // Format headers
        formatted = formatted.replace(/^# (.*)$/gm, "<h4>$1</h4>");

        // Format bold text
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

        // Split into sections
        var sections = formatted.split(/\n\s*\n/);

        var processedSections = sections.map(function (section) {
          section = section.trim();
          if (!section) return "";

          var lines = section.split("\n");
          var numberedListPattern = /^\d+\.\s/;

          var numberedLines = lines.filter(function (line) {
            return numberedListPattern.test(line.trim());
          });

          if (
            numberedLines.length > 0 &&
            numberedLines.length >=
              lines.filter(function (l) {
                return l.trim();
              }).length *
                0.5
          ) {
            var listItems = lines
              .filter(function (line) {
                return line.trim() !== "";
              })
              .map(function (line) {
                if (numberedListPattern.test(line.trim())) {
                  var content = line.replace(/^\d+\.\s*/, "").trim();
                  return "<li>" + content + "</li>";
                } else {
                  return "<li>" + line.trim() + "</li>";
                }
              })
              .join("");
            return "<ol>" + listItems + "</ol>";
          }

          var bulletPattern = /^[-•*]\s/;
          var bulletLines = lines.filter(function (line) {
            return bulletPattern.test(line.trim());
          });

          if (
            bulletLines.length > 0 &&
            bulletLines.length >=
              lines.filter(function (l) {
                return l.trim();
              }).length *
                0.5
          ) {
            var listItems = lines
              .filter(function (line) {
                return line.trim() !== "";
              })
              .map(function (line) {
                if (bulletPattern.test(line.trim())) {
                  var content = line.replace(/^[-•*]\s*/, "").trim();
                  return "<li>" + content + "</li>";
                } else {
                  return "<li>" + line.trim() + "</li>";
                }
              })
              .join("");
            return "<ul>" + listItems + "</ul>";
          }

          var paragraphContent = section.replace(/\n/g, " ").trim();
          return "<p>" + paragraphContent + "</p>";
        });

        var result = processedSections
          .filter(function (section) {
            return section !== "";
          })
          .join("");
        console.log("Formatted result:", result);
        return result;
      }

      function showSuggestedQuestions() {
        if (chatHistory.length === 0) {
          var suggestionsContainer = document.createElement("div");
          suggestionsContainer.className = "suggested-questions";
          suggestionsContainer.id = "suggested-questions";

          var title = document.createElement("div");
          title.textContent = "Quick questions to get started:";
          title.style.fontSize = "14px";
          title.style.color = "#6b7280";
          title.style.marginBottom = "10px";
          title.style.textAlign = "center";
          suggestionsContainer.appendChild(title);

          for (var i = 0; i < suggestedQuestions.length; i++) {
            var question = suggestedQuestions[i];
            var questionBtn = document.createElement("div");
            questionBtn.className = "suggested-question";
            questionBtn.textContent = question;
            questionBtn.onclick = (function (q) {
              return function () {
                input.value = q;
                var suggestions = document.getElementById(
                  "suggested-questions",
                );
                if (suggestions) suggestions.remove();
                sendMessage();
              };
            })(question);
            suggestionsContainer.appendChild(questionBtn);
          }

          messages.appendChild(suggestionsContainer);
        }
      }

      function appendMessage(text, sender, isError, skipSave, timestamp) {
        var suggestions = document.getElementById("suggested-questions");
        if (suggestions) {
          suggestions.remove();
        }

        var existingReplies = document.getElementById("quick-replies");
        if (existingReplies) {
          existingReplies.remove();
        }

        var msg = document.createElement("div");
        msg.className = "message " + sender;

        var messageTimestamp = timestamp || Date.now();
        var timestampDiv =
          '<div class="message-timestamp">' +
          formatTimestamp(messageTimestamp) +
          "</div>";

        if (sender === "bot") {
          if (isError) {
            msg.innerHTML =
              '<div class="error-message">' +
              text +
              '<button class="retry-button" onclick="retryLastMessage()">Retry</button></div>' +
              timestampDiv;
          } else {
            msg.innerHTML =
              formatBotResponse(text) +
              '<div class="message-actions"><button class="copy-btn" onclick="copyMessage(this)">Copy</button></div>' +
              timestampDiv;

            setTimeout(function () {
              showQuickReplies();
            }, 500);
          }
        } else {
          msg.innerHTML = "<div>" + escapeHtml(text) + "</div>" + timestampDiv;
        }

        messages.appendChild(msg);
        messages.scrollTop = messages.scrollHeight;

        if (!isError && !skipSave) {
          chatHistory.push({
            text: text,
            sender: sender,
            timestamp: messageTimestamp,
          });
          saveChatHistory();
        }
      }

      function escapeHtml(text) {
        var div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showQuickReplies() {
        if (document.getElementById("quick-replies")) return;

        var repliesContainer = document.createElement("div");
        repliesContainer.className = "quick-replies";
        repliesContainer.id = "quick-replies";

        for (var i = 0; i < quickReplies.length; i++) {
          var reply = quickReplies[i];
          var replyBtn = document.createElement("div");
          replyBtn.className = "quick-reply";
          replyBtn.textContent = reply;
          replyBtn.onclick = (function (r) {
            return function () {
              input.value = r;
              var repliesEl = document.getElementById("quick-replies");
              if (repliesEl) repliesEl.remove();
              sendMessage();
            };
          })(reply);
          repliesContainer.appendChild(replyBtn);
        }

        messages.appendChild(repliesContainer);
        messages.scrollTop = messages.scrollHeight;
      }

      function copyMessage(button) {
        var messageElement = button.closest(".message.bot");
        var textToCopy = messageElement.textContent
          .replace("Copy", "")
          .replace("Copied!", "")
          .trim();

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(textToCopy)
            .then(function () {
              button.textContent = "Copied!";
              button.className = "copy-btn copied";
              setTimeout(function () {
                button.textContent = "Copy";
                button.className = "copy-btn";
              }, 2000);
            })
            .catch(function () {
              fallbackCopyText(textToCopy, button);
            });
        } else {
          fallbackCopyText(textToCopy, button);
        }
      }

      function fallbackCopyText(text, button) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          button.textContent = "Copied!";
          button.className = "copy-btn copied";
          setTimeout(function () {
            button.textContent = "Copy";
            button.className = "copy-btn";
          }, 2000);
        } catch (err) {
          console.error("Copy failed:", err);
          button.textContent = "Failed";
          setTimeout(function () {
            button.textContent = "Copy";
            button.className = "copy-btn";
          }, 2000);
        }
        document.body.removeChild(textArea);
      }

      function validateInput() {
        var value = input.value;
        var length = value.length;
        var counter = inputCounter;
        var validation = inputValidation;

        counter.textContent = length + "/" + MAX_INPUT_LENGTH;

        counter.className = "input-counter";
        if (length > MAX_INPUT_LENGTH * 0.8) {
          counter.className += " warning";
        }
        if (length >= MAX_INPUT_LENGTH) {
          counter.className += " error";
        }

        var errors = [];

        if (length >= MAX_INPUT_LENGTH) {
          errors.push("Message too long");
          input.className = "error";
        } else {
          input.className = "";
        }

        if (value.trim().length === 0 && length > 0) {
          errors.push("Message cannot be empty");
        }

        if (errors.length > 0) {
          validation.textContent = errors[0];
          validation.style.display = "block";
          return false;
        } else {
          validation.style.display = "none";
          return true;
        }
      }

      function showTypingIndicator() {
        var typingMsg = document.createElement("div");
        typingMsg.className = "message bot typing";
        typingMsg.id = "typing-indicator";
        typingMsg.innerHTML =
          '<span>AI is thinking</span><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        messages.appendChild(typingMsg);
        messages.scrollTop = messages.scrollHeight;
        return typingMsg;
      }

      function removeTypingIndicator() {
        var indicator = document.getElementById("typing-indicator");
        if (indicator) indicator.remove();
      }

      function sendMessage() {
        var question = input.value.trim();

        if (!validateInput() || !question) {
          return;
        }

        lastUserMessage = question;
        updateChatStatus("Sending message...");
        appendMessage(question, "user");
        input.value = "";

        inputValidation.style.display = "none";
        inputCounter.textContent = "0/" + MAX_INPUT_LENGTH;
        inputCounter.className = "input-counter";

        showTypingIndicator();
        updateChatStatus("AI is thinking...");

        fetch("/api/ask-gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: question }),
        })
          .then(function (res) {
            removeTypingIndicator();
            updateChatStatus("Online • Ready to help");
            if (!res.ok) {
              throw new Error(
                "Server error: " + res.status + " " + res.statusText,
              );
            }
            return res.json();
          })
          .then(function (data) {
            if (data.error) {
              throw new Error(data.error);
            }
            appendMessage(data.reply || "⚠️ No reply received.", "bot");
          })
          .catch(function (err) {
            removeTypingIndicator();
            updateChatStatus("Connection error");
            console.error("Chat error:", err);

            var errorMessage = "⚠️ Something went wrong. ";
            if (err.message.indexOf("fetch") !== -1) {
              errorMessage += "Please check your internet connection.";
            } else if (err.message.indexOf("Server error") !== -1) {
              errorMessage +=
                "Our servers are experiencing issues. Please try again.";
            } else {
              errorMessage += "Please try again in a moment.";
            }

            appendMessage(errorMessage, "bot", true);

            setTimeout(function () {
              updateChatStatus("Online • Ready to help");
            }, 3000);
          });
      }

      function retryLastMessage() {
        if (lastUserMessage) {
          input.value = lastUserMessage;
          var errorMsgs = document.querySelectorAll(
            ".message.bot .error-message",
          );
          if (errorMsgs.length > 0) {
            errorMsgs[errorMsgs.length - 1].parentElement.remove();
          }
          sendMessage();
        }
      }

      function initializeChat() {
        console.log("Initializing chat...");
        chatHistory = loadChatHistory();
        restoreChatHistory();
        showSuggestedQuestions();
      }

      // Event listeners
      document
        .getElementById("chat-send")
        .addEventListener("click", sendMessage);

      input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      input.addEventListener("input", validateInput);
      input.addEventListener("paste", function () {
        setTimeout(validateInput, 10);
      });

      // Initialize when ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeChat);
      } else {
        initializeChat();
      }
    </script>
  </body>
</html>
